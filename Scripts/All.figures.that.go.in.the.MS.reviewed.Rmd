---
title: "All_Figures_that_go_on_MS"
author: "Ramon Gallego"
date: "10/30/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro

This Markdown will make the part of the analysis that goes in the Manuscript

```{r libraries and custom functions, echo = F, message=F}
library (RColorBrewer)
library (rstanarm)
library (fitdistrplus)
library (ggridges)
library (ggforce)
library (tidyverse)
library (cowplot)
library (concaveman)
library (vegan)
library (lubridate)
library (ggrepel)
library (factoextra)
library (nnet)
library (here)
library (conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
#functions for future Salish Sea
models <- readRDS(here("Input","full_model_output_rpk_TpH.standardized_nonSeasonal2020-06-24_3262.RDS"))
source(here("Scripts","RPK_climate_model_functions_REVISIONS.R"))

source(here("Scripts","tibble.to.matrix.r"))

stds_to_value <- read_rds(here("Input", "std_to_real.rds"))


```

## Datasets to use

To begin with: the ASV.by.taxa dataset and the environmental data (Updated salinity, DIC and pH)
### Present day datasets
```{r }
data.plankton <- read_csv(here("Input","Combined_Biol_Env_Plankton.csv"))

data.plankton %>% filter(!str_detect(taxa, "Phasianidae")) %>% 
  filter (!str_detect(taxa, "Rhodomelaceae")) -> data.plankton

env.data <- read_csv(here("Input","env.data.for.log.regression.csv"))

#quality-control data
    env.data %>%
      filter(pH > 7) %>%
      mutate(
        Season = case_when(
          str_detect(sample, "1703|1710|1711|1801|1803") ~ "Winter",
          TRUE ~ "Summer"
        ),
        Area = case_when(
          str_detect(sample, "CP|LK|FH") ~ "SJI",
          TRUE ~ "Hood Canal"
        )
      ) -> now.env.data

now.env.data %>%
  gather(-Season, -sample, -Area,  key = "Predictor", value = "value") %>%
  group_by(Area, Predictor) %>%   #RPK: this was missing, which messed up the std calculations 
  mutate(std = vegan::decostand(value, method = "standardize")) -> now.env.data.with.std

#### TODO: remove

# Dataset to go between standarized and real values
now.env.data.with.std %>%
  group_by(Area, Predictor) %>%
  # summarise(mean = mean(value),
  #           sd = sd(value)) %>%
  # group_by(Area, Predictor) %>%
  nest() %>% 
  summarise(tovalue = map(data, ~ lm(value ~ std, data = .x) ),
            tostd   = map(data, ~ lm(std ~ value, data = .x)))-> transforming.df 

transforming.df[1,4] %>% pull -> test
broom::tidy(test[[1]])
extract <- function (lm) {broom::tidy(lm)$estimate}

extract(test[[1]])

transforming.df %>% 
  mutate(to.values = map(tovalue, extract),
         to.std= map(tostd, extract)) ->transforming.df

phylum.info <- read_csv(here("Input","higher_taxonomy.csv")) %>% 
  unite(family, genus, species, sep = "|", col = "taxa")

```
### Future scenarios for the Puget Sound

```{r}
Year.area.dataset <- function(Area, Year, n){
            
    Temp.conv <- stds_to_value[which (stds_to_value$Area == Area & stds_to_value$key == "Temperature"),"toValue"] %>% pull %>% .[[1]]
    pH.conv   <- stds_to_value[which (stds_to_value$Area == Area & stds_to_value$key == "pH")         ,"toValue"] %>% pull %>% .[[1]]
           
    one<-  data.frame(
              Area = Area,
              Year = Year,
              Temperature = r_Temperature_year_STD(Year, Area, n, 2017),
              pH          = r_pH_year_STD(Year, Area, n, 2017)
              ) 
    
    one$TemperatureCelsius = sapply(one$Temperature,function(x){Temp.conv$coefficients[1]+Temp.conv$coefficients[2]*x})
    one$pH_units            = sapply(one$pH,function(x){pH.conv$coefficients[1]+pH.conv$coefficients[2]*x})  
    
    return(one)
            
}



j <- Year.area.dataset("Hood Canal", 2095, 5000)
k <- Year.area.dataset("Hood Canal", 2017, 5000)
l <- Year.area.dataset("SJI", 2095, 5000)
m <- Year.area.dataset("SJI", 2017, 5000)


simulated.scenario <- rbind(j,k,l,m)

rm(j,k,l,m)

simulated.scenario %>%
  group_by(Year, Area) %>% 
  nest() %>% 
  mutate(
    values = map (data, function (.x) {
      list(temp = fitdistr(.x$TemperatureCelsius ,
             densfun = "normal"),
           ph = fitdistr(.x$pH_units ,
             densfun = "normal"))
            }
          ),

    data = map2(data,values,  function (.x, .y){
      .x %>%
        mutate(pT = pnorm(TemperatureCelsius, mean  = .y[["temp"]]$estimate[1], sd = .y[["temp"]]$estimate[2]),
               ppH =pnorm(pH_units, mean  = .y[["ph"]]$estimate[1], sd = .y[["ph"]]$estimate[2]) )
      })
    ) %>% 
  unnest(data) %>% 
  mutate(keep = case_when(pT < 0.05 | ppH < 0.05 | pT > 0.95 | ppH > 0.95 ~ "Discard",
                          TRUE                   ~ "keep")) %>% 
  filter (keep == "keep")-> simData.nocrazys

simData.nocrazys %>% 
  select(-values) %>% write_csv("Output/simulation.from.std.functions.cleaned.csv")
```

### Save future scenarios

```{r}

simData.nocrazys %>%
  
saveRDS( file = here("Output","all.sim.data_climateScenarios_no.outliers.RDS"))

simData.nocrazys %>% 
  group_by( Area, Year) %>% 
  summarise_at(c("TemperatureCelsius", "pH_units"), .funs = list(min = min, max = max)) 

```

### Seasonality

To proyect the different community clusters fate into the pH - Temperature continuum, we need to include the seasonality or ditch it from the CAP Analysis. Here I am 
Now create a seasonal data, we can sample each year's data and select them with the profile for the seasonal data in the real dataset. By calculating the quantiles of the Temperature distributions, we see that both in the San Juan Islands and the Hood Canal, the Winter months occupy the lower 30% quantile of the data. In order to create a matrix of possible ranges of pH and Temperature for each season in the future scenario, we will apply these quantiles to the simulated data

```{r}
simData.nocrazys %>% 
  mutate(Season = case_when(pT < 0.3 ~ "Winter",
                            TRUE     ~ "Summer")) %>% 
  ggplot(aes(x = TemperatureCelsius, fill = Season)) +
  geom_density_ridges_gradient(aes(y = as.factor(Year))) +
  facet_wrap(~Area, nrow = 2)
```

Now get the ranges and create the grid for each season / Area

```{r get the ranges}

simData.nocrazys %>% 
  mutate(Season = case_when(pT < 0.3 ~ "Winter",
                            TRUE     ~ "Summer")) %>% 
  group_by(Area, Season) %>% 
  summarise_at (c("TemperatureCelsius", "pH_units"), .funs = list(min = min, max = max)) -> seasonal.ranges
```


```{r}
simData.nocrazys %>% 
  select(Area, Temperature, pH, Year) %>% 
  pivot_longer(cols = c(pH, Temperature), names_to = "Predictor", values_to = "value") -> simData.nocrazys.long

 simTemp <- r_T_year_STD(2017, 1000, 2017) %>% 
    sort()
  #what quantile of the simulated data is each of the observed points in?
  simECDF <- ecdf(simTemp) #create ecdf function from sim distribution, then find quantile for each observed point
quantile_df <- function(x, probs, na.rm =F, names = F, type = 7, ...){
  z <- quantile(x, probs, na.rm, names, type)
  output <- tibble(id = probs,
                       values = z)
         
      return(output)   
}

 models$data[[1]] %>% 
    select(-sample, -Noccur, -phylum, -binary) %>% 
    pivot_longer(cols = c(-Season, -Area),names_to = "Predictor", values_to = "value") %>% 
    filter (Predictor == "Temperature") %>% 
   group_by(Season, Area, Predictor) %>%
    nest()-> testdata 
   

testdata %>% 
  unnest(data) %>% ungroup() %>% 
  select(-Season) %>% 
  group_by(Area, Predictor) %>% 
  nest(value) %>% 
  mutate(Season = "All") %>% 
  bind_rows(testdata, .) %>% 
  
  mutate(
    betas = map(data, function(.x){
      pull(.x) %>% 
      sort() %>% 
        simECDF() %>% 
        fitdist("beta")}),
    quantiles = map (data,  ~ quantile_df(.x$value, probs = c(0, 0.25, 0.5, 0.75, 1)))) -> testdata

testdata %>% 
  left_join(transforming.df %>% select(Area, Predictor, to.values)) %>% 
  mutate(quantiles = map2(quantiles, to.values, ~.x %>% 
                       mutate(real = .y[1]+.y[2]*values ))) %>% 
# unnest(quantiles) %>% 
#   select(-values) %>% 
#   pivot_wider(names_from = id, values_from = real) %>% 
#   filter(Predictor == "Temperature") %>% 
#   arrange(Area)
  nest(-Area) %>% 
  expand_grid(., Year = c(2017, 2095)) %>% 
  unnest(data) %>% 
  nest_join(simData.nocrazys.long, by = c("Area","Predictor", "Year"), name = "new") %>% 
  mutate(lims = map2(new, betas,
                     function(.x, .y){
                       .x %>%
                         pull(value) %>% 
                         sort() -> temps 
          base::sample(temps, 
                       size = 500, 
                       replace = TRUE, 
                       prob = rbeta(length(temps), shape1 = .y$estimate[1], shape2 =.y$estimate[2])) -> temps
          

          quantile_df(temps, probs = c(0,0.2, 0.5, 0.7, 1))
          } )) %>%
 
  mutate(lims.real = map2(lims, to.values, ~.x %>% 
                       mutate(real = .y[1]+.y[2]*values ))) %>% 
# unnest(lims.real) %>% 
  unnest(quantiles) %>% 
  select(-values) %>% 
  pivot_wider(names_from = id, values_from = real)
```


## Figure 1


We have the datasets and some plots already made - 

### Panel A Sample location
```{r Base map}
map <- readRDS(here("Input","map.plot.rds"))

map + ggtitle(label = element_blank()) + labs (x = "Longitude", y = "Latitude") -> map

```
### Panel B Environmental variation

Make the ridges plot

```{r}
now.env.data %>% 
  select(TA = mean.TA, DIC = mean.DIC, everything(), -contains("%")) %>% 
  filter(!is.na(TA)) %>% 
  separate(sample, into= c("Site","Date"), remove = F )-> env.data.no.outliers

env.data.no.outliers %>% 
  pivot_longer(cols = c(-Area, -Site, -Date, -Season, -sample), names_to =   "Predictor", values_to  = "value") -> env.data.to.keep

env.data.to.keep %>% 
  mutate(Site = fct_relevel(Site, "SA", "TR", "LL","PO", "TW"),
         Predictor = fct_relevel(Predictor, "DIC", "TA", "pH")) -> env.data.to.keep 


env.data.to.keep %>% 
  mutate(Area = case_when (Area == "SJI" ~ "San Juan Island",
                           TRUE          ~ Area)) %>% 
  mutate(Month = month(ymd(paste0(Date, "01")), label = T, abbr = F)) %>% 
  filter (Predictor %in% c("DIC", "TA", "pH", "Temperature", "Salinity")) %>% 
  ggplot(aes(x = `value`, y = `Month`, fill = Area)) +
  geom_density_ridges_gradient() +
 # scale_fill_viridis(name = "Temp. [F]", option = "C") +
  facet_wrap(~fct_relevel(Predictor, "DIC", "TA", "pH", "Temperature", "Salinity"), scales = "free", nrow = 1) +
  theme(legend.direction ="horizontal") -> ridges

legend <- get_legend(
  # create some space to the left of the legend
  ridges + theme(legend.box.margin = margin(0, 0, 0, 12))
)
 legend
ridges + guides(fill = "none") -> ridges
```

### Panel c: Richness variation

```{r}
boxplot.richness <- readRDS(here("Input","richness.rds"))

boxplot.richness +
  ylim (0,60) -> boxplot.richness
```
### All together

THe top will be the environmental gradients, the lower panels will have the map and the boxplot
```{r}
plot_grid(plotlist = list(map, legend, boxplot.richness),
                     align = "v",
                     ncol = 3, 
          axis = "t",
          rel_widths = c(1,0.5,0.6))   -> bottom.half.plot1
    
plot_grid(plotlist = list(ridges, bottom.half.plot1),
          align = "hv",
          ncol = 1, 
          nrow = 2,
          rel_heights = c(1,0.8),
          rel_widths = 1) 

plot_grid(plotlist = list(legend, boxplot.richness),
                     align = "hv",
                     ncol = 1, 
          axis = "t",
          rel_heights  = c(.5,1),
          labels = c(NA,"B" )) -> bottom.right

plot_grid (plotlist = list(map, bottom.right),
           align = "hv",
           nrow = 1,
           rel_heights = 1,
           rel_widths = c(.6,0.4),
           labels = c("A", NA)) -> bottom.plot

plot_grid(bottom.plot, ridges,
          align = "h",
          nrow = 2,
          rel_heights = c(0.6, 0.4),
          labels = c(NA,"C")) +
  ggsave(filename = here("Figures","Fig1.png"), width = 14, height = 14, dpi = "retina")

```

## Figure 2

```{r functions for CAPS}
cap.functions.only3things <- function(tibble, ...){ # ..  are the grouping factors
  
  tibble %>% 
    
    group_by(...) %>% 
    
    nest() %>% 
    
    mutate(comm.matrix = map (data, ~ tibble.to.table(.x, taxon = taxa, Abundance = Normalized.reads, sample.name = event)),
         
           ja = map(data, ~tibble_to_matrix(.x, taxon = taxa,Abundance = Normalized.reads, sample.name = event, distance = "jaccard",transformation = "binary" )),
          bc = map(data, ~tibble_to_matrix(.x, taxon = taxa,Abundance = Normalized.reads, sample.name = event, distance = "bray",transformation = "" )), # the bc distamce
          env = map (data, ~tibble_to_env(.x, taxon = taxa, Abundance = Normalized.reads, sample.name = event, everything()) %>% 
                       select(-contains("%")) %>% 
                       separate(event, into = c("Site", "Date"), sep = "_")))
}

raw.PCAs <- function(nested.tibble){
  
  nested.tibble %>% 
    mutate(
  
  CAP.analysys.raw = map2(comm.matrix, env,
                          
                          function(.x,.y) {
                            .y %>% select (Temperature, Salinity = Salinity.new, pH = pH_new) 
                            caps <-  capscale(formula = .x ~ Temperature + Salinity + pH ,
                                                 data = .y %>%
                                                   select(DIC = mean.DIC.new.sal, Salinity = Salinity.new, Temperature, pH = pH_new) %>% 
                                                   select_if(is.numeric) %>%
                                                   decostand(method = "standardize", na.action = na.omit),
                                                 distance = "jaccard", 
                                                binary = T)
         
                            sppscores(caps) <- sqrt(decostand(.x, "total"))
                              
                            return(caps) }),
  
  
  CAP.plot = map (CAP.analysys.raw, ~ plot(.x)),
  
  CAP.signficance = map(CAP.analysys.raw, ~ permutest(.x, permutations = 999 )),
  
  gp.plot = map2 (CAP.plot, env, function (.x, .y){


                         .x$sites %>%
                          as.data.frame() %>%
                          rownames_to_column("sample") %>%
                  
                          separate(sample, into = c("Site", "Date"), sep = "_",remove = F) %>%
                          mutate(Date = ymd(Date),
                                 Date2 = paste(month(Date, label = T, abbr = T), year(Date), sep = "' "),
                                 Month = month(Date, label = T)) -> site.scores # pull the  site scores
                        
                        site.scores %>% 
                          mutate(Date = as.character(Date)) %>% 
                          left_join(.y) -> site.scores.plot


                        scalate.corrs <- c(CAP1max =  max(abs(site.scores$CAP1)), CAP2max =  max(abs(site.scores$CAP2)))



                        .x$species %>%
                        as.data.frame() %>%
                        rownames_to_column("taxa") %>%
                          separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
                          mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                                                   species == "NA" ~  paste0(genus, " sp."),
                                                   TRUE            ~ species),
                                 scaledCAP1 = CAP1 * scalate.corrs["CAP1max"],
                                 scaledMDS1 = CAP2 * scalate.corrs["CAP2max"]) %>%
                          mutate (rate = rank(abs(CAP1)),
                                  corr = sqrt(CAP1^2 + CAP2^2)) %>%
                         arrange (desc(rate)) %>%
                          slice (1:10) -> species.scores # Keep only the top 20 matches

                       .x$biplot %>%
                         as.data.frame() %>%
                        rownames_to_column("env.variable") -> var.scores

                        ggplot (aes (x= CAP1, y = CAP2), data = site.scores.plot) +
                          geom_point(aes(
                            color = pH < 8 )) +
                          geom_segment(aes(x = 0, y = 0,
                                           xend = CAP1,
                                           yend = CAP2), data = var.scores, color = "blue", arrow = arrow(length = unit(0.1,"cm"))) +
                          geom_label_repel(aes(x= CAP1  ,
                                         y= CAP2 ,
                                         label = env.variable), data = var.scores, fill = "pink", alpha = 0.75) +

                          guides(color = guide_legend(title = "pH < 8")) -> p # The basic plot



                        p +
                          
                          geom_segment(aes(x = 0, y = 0,
                                           xend = CAP1 * scalate.corrs["CAP1max"] ,
                                           #yend = 0),
                                           yend = CAP2 * scalate.corrs["CAP2max"]), 
                                       data = species.scores, color = "red", arrow = arrow(length = unit(0.1,"cm"))) +

                          geom_label_repel(aes(x= CAP1 * scalate.corrs["CAP1max"] ,
                                         #      y = 0,
                                         y= CAP2 * scalate.corrs["CAP2max"],
                                         label = label), data = species.scores, fill = "lightblue", alpha = 0.75, size = 1.5) -> p.with.spp # The species corr
                          # ggsave("CAP_with_species.png",
                          #        dpi = "retina",
                          #        width = 7) +
                          #ggedit::remove_geom('label',) +
                       

                        return (list (basic = p, spp = p.with.spp))
                       #return(bind_rows(site.scores, var.scores, species.scores ))
                        } ) ,
  
  nclusters = map (CAP.plot, ~  fviz_nbclust( .x$sites, kmeans, k.max = 5, method = "silhouette")),
  
  n_clust = c(4,3,3,3),
  
  CAP.clusters = map2 (CAP.plot,n_clust,  function (.x, .y) {
    
    final <- kmeans(.x$sites, .y, nstart = 15) 
    
    fviz_cluster(final, data = .x$sites, geom = "point", palette = "Set2")
    
  } ),
  
  Cluster.df = map2 (CAP.plot,n_clust,  function (.x, .y) {
    
    final <- kmeans(.x$sites, .y, nstart = 15) 
    
    tibble(event = names(final$cluster),
           cluster = final$cluster) }
    
    ),
  
  Final.plot = map2(CAP.plot, CAP.clusters, function (.x, .y) {
     
                        .x$biplot %>%
                         as.data.frame() %>%
                        rownames_to_column("env.variable") -> var.scores
    
                          .x$sites %>%
                          as.data.frame() %>%
                          rownames_to_column("sample") %>%
                            separate(sample, into = c("Site", "Date"), sep = "_",remove = F) %>%
                            mutate(Date = ymd(Date),
                                 Date2 = paste(month(Date, label = T, abbr = T), year(Date), sep = "' "),
                                 Month = month(Date, label = T)) -> site.scores 
    
    .y +
      #geom_label(aes(x= CAP1, y = CAP2, label = Month), data = site.scores) +
      geom_segment(aes(x = 0, y = 0,
                       xend = CAP1,
                       yend = CAP2), data = var.scores, color = "blue", arrow = arrow(length = unit(0.1,"cm"))) +
      geom_label_repel(aes(x= CAP1  ,
                           y= CAP2 ,
                           label = env.variable), data = var.scores, fill = "pink", alpha = 0.75) 
      
    
    
    
  })
  

    )}

```


We will do the Full CAP analysis - but will only keep Hood Canal in summer for the MS - the rest will have to go to the Supplementary information

The figure will have three panels: the CAP for HC-summer , the probability of presence of each cluster in the pH/Temperature space

```{r CAP analysis FULL}

data.plankton %>% 
  separate (event, into = c("Site", "Date"), sep = "_") %>% 
  mutate(Season = case_when(str_detect(Date,"17-03|17-10|17-11|18-01|18-03") ~ "Winter",
                             TRUE ~                                         "Summer"),
         Area = case_when(Site %in% c("CP","LK", "FH") ~ "San Juan Island",
                          TRUE                         ~ "Hood Canal")) %>% 
   unite (Site, Date, col = "event", sep = "_") %>% 
  cap.functions.only3things(Area, Season) -> joined.dataset.for.CAP
```
Use the functions
```{r lets CAP this}
joined.dataset.for.CAP %>% 
  ungroup %>% 
 # select(DIC = mean.DIC.new.sal, Salinity = Salinity.new, Temperature, pH = pH_new, everything())
  raw.PCAs  %>% 
  mutate(Titles = paste(Area,Season, sep = " - " )) -> Clusters.analysis.and.cap
```


```{r get the plots}

Clusters.analysis.and.cap %>% 
  select(Titles, Final.plot) %>% 
  mutate(Final.plot = map2(Titles, Final.plot, ~ .y + ggtitle(.x) )) %>% 
  pull(Final.plot) -> list.of.cluster.plots

names(list.of.cluster.plots) <- Clusters.analysis.and.cap$Titles

# We keep only the Hood Canal in Summer - we are using _scale_color_brewer set 2

list.of.cluster.plots[[ "Hood Canal - Summer"]] -> left.most.plot


left.most.plot + ggtitle ("") +coord_equal() + scale_color_brewer(palette = "Set2")-> left.most.plot
#+ theme_cowplot() + 
left.most.plot + theme(legend.position = "bottom")  -> left.most.plot

legend <- get_legend(left.most.plot)
 

left.most.plot + theme(legend.position = "none") -> left.most.plot

Clusters.analysis.and.cap %>% 
  mutate(full.cluster.info = map2(env, Cluster.df, ~ .x %>% unite(Site, Date, col = "event") %>%right_join(.y) ),
         full.cluster.info = map2(full.cluster.info,CAP.plot, ~ .y$sites %>% 
                                    as.data.frame() %>% 
                                    rownames_to_column("event") %>% 
                                    right_join(.x) %>% 
                                    mutate(pH = round(pH,1))),
         Final.plot2 = map2(Final.plot,full.cluster.info, ~ .x +
                             geom_label_repel(data = .y, 
                                              aes(x = CAP1, y = CAP2, label = cluster)))) -> Clusters.analysis.and.cap

Clusters.analysis.and.cap %>% 
  select(Area, Season, full.cluster.info) %>% 
  unnest() %>% #filter (Area == "Hood Canal", Season == "Summer") %>% 
  write_csv(here("Output","clusters.of.events.csv"))
Clusters.analysis.and.cap %>% pull(Final.plot2) 
```

```{r capture legend}



Clusters.analysis.and.cap %>% 
  slice(3) %>% 
  mutate(Hand.made.CAP = map2(CAP.plot, full.cluster.info, function (.x, .y){
    
    
    .x$biplot %>%
                         as.data.frame() %>%
                        rownames_to_column("env.variable") -> var.scores
    
    # return(.y %>% 
    #   select(event, CAP1, CAP2, cluster))
    .y %>% 
      select(event, CAP1, CAP2, cluster) %>% 
      ggplot(aes(x = CAP1,
                 y = CAP2)) +
      ggforce::geom_mark_hull(aes( group= cluster, color = as.factor(cluster),label = as.factor(cluster), fill = as.factor(cluster)),
                          expand = unit(1, "mm"),
                 label.margin = margin(1, 1, 1, 1, "mm"),
                 label.buffer = unit(0, "mm"),
                 con.cap = 1 ,
                 alpha = 0.5) +
     
      geom_point(size = 1.5) +
       geom_point(aes(color = as.factor(cluster)), size = 1) +
    #  geom_label(aes(x= CAP1, y = CAP2, label = Month), data = site.scores) +
      geom_segment(aes(x = 0, y = 0,
                       xend = CAP1,
                       yend = CAP2), data = var.scores, color = "blue", arrow = arrow(length = unit(0.1,"cm"))) +
      geom_label_repel(aes(x= CAP1  ,
                           y= CAP2 ,
                           label = env.variable), data = var.scores, fill = "pink", alpha = 0.75) +
      ggtitle ("") + coord_equal() + scale_color_brewer(name = "Cluster", palette = "Set2") + scale_fill_brewer(name = "Cluster",palette = "Set2") +
     # guides(color ="Cluster" ) +
      theme(legend.position = "bottom")
      

  })) %>% pull(Hand.made.CAP) -> leftplot.Fig2

legend <- get_legend(leftplot.Fig2[[1]])
leftplot.Fig2 [[1]]+  theme(legend.position = "none") -> leftplot.Fig2

```


###Expand the plots to all seasons and areas for supplementary material
```{r}
Clusters.analysis.and.cap %>% 

  mutate(Hand.made.CAP = map2(CAP.plot, full.cluster.info, function (.x, .y){
    
    
    .x$biplot %>%
                         as.data.frame() %>%
                        rownames_to_column("env.variable") -> var.scores
    
    # return(.y %>% 
    #   select(event, CAP1, CAP2, cluster))
    .y %>% 
      select(event, CAP1, CAP2, cluster) %>% 
      ggplot(aes(x = CAP1,
                 y = CAP2)) +
       geom_mark_ellipse(aes(fill = as.factor(cluster))) +
      # ggforce::geom_mark_hull(aes( group= cluster, color = as.factor(cluster),label = as.factor(cluster), fill = as.factor(cluster)),
      #                     expand = unit(1, "mm"),
      #            label.margin = margin(1, 1, 1, 1, "mm"),
      #            label.buffer = unit(0, "mm"),
      #            con.cap = 1 ,
      #            alpha = 0.5) +
     
      geom_point(size = 1.5) +
       geom_point(aes(color = as.factor(cluster)), size = 1) +
    #  geom_label(aes(x= CAP1, y = CAP2, label = Month), data = site.scores) +
      geom_segment(aes(x = 0, y = 0,
                       xend = CAP1,
                       yend = CAP2), data = var.scores, color = "blue", arrow = arrow(length = unit(0.1,"cm"))) +
      geom_label_repel(aes(x= CAP1  ,
                           y= CAP2 ,
                           label = env.variable), data = var.scores, fill = "pink", alpha = 0.75) +
      ggtitle ("") + coord_equal() + scale_color_brewer(name = "Cluster", palette = "Set2") + scale_fill_brewer(name = "Cluster",palette = "Set2") +
     # guides(color ="Cluster" ) +
      theme(legend.position = "bottom")
      

  })) %>% pull(Hand.made.CAP) -> list.of.left.plots
```


### Panel B: Get bits of script from RPK

```{r}


  TpH_likelihood <- function(focalArea, focalYear, focalSeason, minT, pHmax) {
    require(tidyverse)
    
    all.sim.data %>% 
      filter(Area == focalArea,
             Year == focalYear,
             Season == focalSeason) %>% 
      group_by(TemperatureCelsius > minT & pH_units < pHmax) %>% 
      summarize(NumberObs = n()) %>% 
      summarize(NumberObs[2]/(NumberObs[1] + NumberObs[2])) %>% 
      as.numeric()
  }
```
Load the objects
```{r}
all.sim.data <- simData.nocrazys  #to see simulation data

clusters <- read.csv(here("Input","clusters.of.events.csv")) %>% 
  filter(Season == "Summer",
         Area == "Hood Canal")
  clusters$cluster <- as.factor(clusters$cluster)
```

```{r models and so for getting the communities}
multi.mod <- multinom(cluster ~ Temperature + pH_new, data = clusters)
  z <- summary(multi.mod)$coefficients/summary(multi.mod)$standard.errors
  p <- (1 - pnorm(abs(z), 0, 1)) * 2
  p  #T and pH signif predictors for all conditions


  #predict(multi.mod, type = "probs") #get probs for each cluster at each set of enviro conditions
  
  #at median conditions for HC Summer 2015
  predict(multi.mod, 
          type = "probs", 
          newdata = data.frame(Temperature = median(clusters$Temperature),
                       pH_new = median(clusters$pH_new))
  )
  
  #in scenario w Temp = 19, pH = 7.9, the low-pH community is nearly certain under our model
  predict(multi.mod, 
          type = "probs", 
          newdata = data.frame(Temperature = 19,
                               pH_new = 7.9)
  )


#build a heatmap; likelihood of low-pH / high-T community under different parameter sets

pH.range <- seq(7.5, 8.5, length.out = 12)
T.range <- seq(12, 27, length.out = 22)

#build heatmap of frequency of these climate thresholds
        threshold.res <- as.data.frame(matrix(NA, nrow = length(pH.range), ncol = length(T.range)))
        for (i in 1:length(pH.range)){
          for (j in 1:length(T.range)) {
            
            threshold.res[i,j] <-    predict(multi.mod, 
                    type = "probs", 
                    newdata = data.frame(Temperature = T.range[j],
                                         pH_new = pH.range[i])
            )[2]  #second element is the low-pH/high-T community
          }
        }
        threshold.res <- round(threshold.res, 3)
        
        row.names(threshold.res) <- paste0("pH_",pH.range)
        colnames(threshold.res) <- paste0("T_",T.range)
        
whichComm.res <- as.data.frame(matrix(NA, nrow = length(pH.range), ncol = length(T.range)))
          for (i in 1:length(pH.range)) {
            for (j in 1:length(T.range)) {
              whichComm.res[i, j] <- as.numeric(
                which.max(
                  predict(multi.mod,
                    type = "probs",
                    newdata = data.frame(
                      Temperature = T.range[j],
                      pH_new = pH.range[i]
                    )
                  )
                )
              )
            }
          }
        
        
        row.names(whichComm.res) <- paste0("pH_",pH.range)
        colnames(whichComm.res) <- paste0("T_",T.range)

```



And the plot

```{r}

 whichComm.res %>% 
          rownames_to_column("pH") %>% 
          gather(key = "Temperature", value = "Community", -pH) %>% 
          separate(pH, into = c("p", "pHvalue"), sep = "_") %>% 
          separate(Temperature, into = c("Td", "Tvalue")) %>% 
          dplyr::select(-p, -Td) %>% 
          mutate(pHvalue = as.numeric(pHvalue),
                 Tvalue = as.numeric(Tvalue)) %>% 
  group_by(Community) %>% 
  summarise_all(mean) -> centroids.of.comms

 whichComm.res %>% 
          rownames_to_column("pH") %>% 
          gather(key = "Temperature", value = "Community", -pH) %>% 
          separate(pH, into = c("p", "pHvalue"), sep = "_") %>% 
          separate(Temperature, into = c("Td", "Tvalue")) %>% 
          dplyr::select(-p, -Td) %>% 
          mutate(pHvalue = as.numeric(pHvalue),
                 Tvalue = as.numeric(Tvalue)) %>% 
          ggplot(aes(y = pHvalue, x = Tvalue, fill = as.factor(Community))) + 
          geom_tile() +
          geom_label(data = centroids.of.comms,
                     aes (x = Tvalue,
                          y = pHvalue,
                          label = Community), color = "white") +
   
          scale_fill_brewer(palette = "Set2") +
          xlab("Temperature") + ylab("pH") +
          guides(fill = "none") -> right_top
          #ggtitle("Most-Likely Community")+ 
          #theme_cowplot() 
 
# right_top + coord_equal () -> right_top 
 ggsave(here("Figures","Figure2.topright.png"), width = 7)
```

### Repeat the above for all seasons and areas

```{r}
all.sim.data <- simData.nocrazys  #to see simulation data

clusters.all <- read.csv(here("Input","clusters.of.events.csv") )
 
  clusters.all$cluster <- as.factor(clusters.all$cluster)
```

Models

```{r}
simData.nocrazys %>% 
  ungroup %>% 
  mutate(Area = as.character(Area),
         Area = case_when(Area == "SJI" ~ "San Juan Island",
                          TRUE          ~ Area)) %>% 
  group_by( Area) %>% 
  summarise_at(c("TemperatureCelsius", "pH_units"), .funs = list(min = ~ min(round(.x, 1)), max = ~max(round(.x, 1)))) %>% 
  group_by (Season, Area) %>% 
  nest() %>% 
  mutate(data = map (data, ~ expand_grid(Temperature = seq(round(.x$TemperatureCelsius_min,1), round(.x$TemperatureCelsius_max, 1),by = 0.1),
                                         pH_new = seq(round(.x$pH_units_min,1), round(.x$pH_units_max,1), by = 0.1)))) -> limits.for.planb


Clusters.analysis.and.cap %>% 
  select(Area, Season, full.cluster.info) %>% 
  left_join(limits.for.planb) %>% 
  mutate(multimod = map (full.cluster.info, ~ .x %>% 
                           mutate(cluster = as.factor(cluster)) %>% 
                           multinom(cluster ~ Temperature + pH_new, data = . )),
         z = map (multimod, ~ summary(.x)$coefficients / summary(.x)$standard.errors),
         p = map (z, ~ (1 - pnorm(abs(.x), 0, 1)) * 2),
         threshold.res = map2(multimod, data, ~ predict (.x, 
                                                         type = "probs",
                                                         newdata = .y) %>% 
                                as.data.frame() %>% 
                                bind_cols(.y) %>% 
                                pivot_longer(cols = c(-Temperature, -pH_new),
                                             names_to = "Cluster",
                                             values_to = "p") %>% 
                                group_by(Temperature, pH_new) %>% 
                                arrange(desc(p)) %>% 
                                slice(1)),
         plot = map (threshold.res, ~.x %>% 
                       ggplot(aes(y = pH_new, x = Temperature, fill = as.factor(Cluster))) + 
          geom_tile() +
          scale_fill_brewer(name = "Cluster",palette = "Set2") +
          geom_label(data = .x %>% group_by(Cluster) %>% summarise_all(mean),
                     aes (x = Temperature,
                          y = pH_new,
                          label = Cluster), color = "white"))) %>% pull(plot) -> list.of.mid.plots

```

### Panel C: For each cluster, follow the relative abundance of the taxa driving the differences

Generate the SIMPER clusters
```{r}
Clusters.analysis.and.cap %>% 
  mutate(SIMPER.clusters = map2(comm.matrix, Cluster.df, function(.x, .y) {
    
    simper(comm = .x,
          group = as.factor(.y$cluster),
          permutations = 999)
    
  })) %>% 
  select(Area, Season, SIMPER.clusters) -> SIMPER.clusters 

SIMPER.clusters %>% 
  mutate(summary.simper = map(SIMPER.clusters, ~ summary(.x, ordered  = TRUE) )) %>% 
  mutate(taxa.simper = map(summary.simper, ~ map(.,function(x) rownames_to_column(x, var = "taxa") %>% pull(var = taxa)   )[[1]])) -> SIMPER.clusters


SIMPER.clusters %>% 
  filter (Area == "Hood Canal", Season == "Summer") %>% 
  pull(summary.simper) -> list.simpr 
list.simpr %>% flatten_df(.id = "comparison") ->simper2

  simper2 %>% 
    group_by(comparison) %>% 
    nest() %>% 
    mutate(data = map (data, ~ .x %>% bind_cols(SIMPER.clusters %>% 
                                                filter (Area == "Hood Canal", Season == "Summer") %>%
                                                ungroup() %>% 
                                                select(taxa.simper) %>% 
                                                unnest()))) %>% 
    unnest(data) %>% 
  filter (p < 0.05) %>% 
  write_csv(here("Output","simper.HoodCanal.summer.csv"))


## Get the data for all seasons and areas
 SIMPER.clusters %>%
   pull(summary.simper)-> list.of.simpers
names(list.of.simpers) <- paste(SIMPER.clusters$Area, SIMPER.clusters$Season, sep = "_")

 list.of.simpers %>%
  map(~ .x %>% map(~ bind_rows(.)) %>% 
                          bind_rows(., .id = "Comparison")) %>% 
  bind_rows(., .id = "var1") %>%
   separate(var1, into = c("Area", "Season"), sep = "_") %>%
   group_by(Area, Season, Comparison) %>% 
   nest() %>% 
   left_join(SIMPER.clusters) %>%
   mutate(data = map2(data, taxa.simper, ~bind_cols(.x, as_tibble(.y)))) %>% 
   select(Area, Season, Comparison, data) %>% 
   unnest(data) %>% 
  # rename(taxa = value) %>% 
  write_csv(here("Output","simper.all.csv") )
   

  
```
#### Now do the dreamed panel
```{r}
taxa.to.follow <- read_csv(here("Output","simper.HoodCanal.summer.csv"))

taxa.to.follow %>% 
  filter (p<0.01, cumsum < 0.7) %>%  
  transmute(comparison, taxa = taxa.simper, diff = avb - ava) %>% 
  separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species)) %>%
  mutate(comparison = fct_relabel(comparison, ~ str_replace(.,"_", " vs "))) %>% 
  separate(comparison, into = c("a", "b"), remove = F) %>% 
  ggplot(aes(y = diff,
             x = fct_reorder(label, diff)))+
  geom_col(aes(fill = diff>0))+
  geom_hline(yintercept = 0, color = "black")+
  labs (x = "taxa",
        y = "Mean difference")+
  coord_flip()+
  facet_wrap(~comparison)+
  guides(fill = "none") +
  theme(axis.text.y = element_text(face = "italic"))  -> right_most
  
## And now do the same thing for all seasons and areas

all.taxa.to.follow <- read_csv(here("Output","simper.all.csv"))

all.taxa.to.follow %>% 
  group_by(Area, Season) %>% 
  nest() %>% 
  mutate(plot = map (data, ~ .x %>% 
                       filter (p<0.01, cumsum < 0.7) %>%  
                       transmute(comparison = Comparison, taxa = value, diff = avb - ava) %>% 
                       separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
                       mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species)) %>%
                       mutate(comparison = fct_relabel(comparison, ~ str_replace(.,"_", " vs "))) %>% 
                       separate(comparison, into = c("a", "b"), remove = F) %>% 
                       ggplot(aes(y = diff,
                                  x = fct_reorder(label, diff))) +
                       geom_col(aes(fill = diff>0)) +
                       geom_hline(yintercept = 0, color = "black") +
                       labs (x = "taxa",
                             y = "Mean difference") +
                       coord_flip() +
                       facet_wrap(~comparison) +
                       guides(fill = "none") +
                       theme(axis.text.y = element_text(face = "italic")) )) %>% pull(plot) -> list.of.right.plots

```
### Final Figure 2

```{r assembling Figure 2}

plot_grid(leftplot.Fig2, right_top, right_most,align = "hv",nrow = 1, labels = "AUTO") -> top.plots
   
plot_grid(top.plots , legend, align = "v", nrow = 2, rel_heights = c(1, 0.1))  

ggsave(filename = here("Figures",paste0("Figure2.", Sys.Date(), ".png")),
         width = 14,height = 5, dpi = "retina") 

```

```{r assembling Figure for Supplementary material}

list.of.left.plots %>% map (get_legend) -> list.of.legends
list.of.left.plots %>% map(~.x + theme(legend.position = "none")) -> list.of.left.plots

list.of.mid.plots  %>% map(~.x + theme(legend.position = "none")) -> list.of.mid.plots

list.of.right.plots
Clusters.analysis.and.cap %>% 
  mutate (label = paste (Area, Season, sep = " ")) %>% 
  pull(label) -> list.of.labels

pmap(.l = list(list.of.left.plots, list.of.mid.plots, list.of.right.plots),
      .f = function(a,b,c) plot_grid(a,b,c,align = "hv",nrow = 1, labels = "auto")) -> top.plots.in.a.list

pmap(.l = list(top.plots.in.a.list, list.of.legends, list.of.labels),
     .f = function(a,b,c) plot_grid(a,b, align = "v", nrow = 2, rel_heights = c(1, 0.1), labels = c) +
       ggsave(filename = here("Figures",paste0(c,"CAP.plot.png")),  width = 14,height = 5, dpi = "retina")) -> plots.ready.to.go

plots.ready.to.go %>% saveRDS(here("Output","All_Cap_for_suppplemental.rds"))
```


## Figure 3: a quick glance at spp responses
Get the models output and calculate the posterior across the simulated scenario




Now, calculate the posterior of each taxa across the 7600 scenarios simulated

### Posterior per taxa per point in the future

We use the climate projection to predict changes in suitability 

```{r}


all.sims.for.projection <- simData.nocrazys %>% 
  select(Area, Year, Temperature, TemperatureCelsius, pH, pH_units) 

## Get 
models %>% 
  transmute(taxa, 
            post.draws = map2 (model, taxa, ~ posterior_predict(object = .x,
                                                                newdata = all.sims.for.projection,
                                                                draws = 100) %>% 
                                 as_tibble() %>% 
                                 t(.) %>% 
                                 as_tibble() %>% 
                                 rownames_to_column("sim.row") )) -> posterior.draws.all

# This is an object with as many rows as environmental points there are. The first two columns are taxa and nrow. The rest are the binary output of the posterior
# predict

posterior.draws.all %>% 
 left_join(phylum.info %>% dplyr::select(phylum, taxa)) %>% 
  group_by(phylum) %>% # Add phylum information
  nest() %>% 
   mutate (data = map (data, ~ .x %>% 
                        unnest() %>% 
                        pivot_longer(cols = c(-taxa, -sim.row),
                                    names_to = "draw.row", values_to = "presence") %>% 
  group_by(taxa, sim.row) %>% 
  summarise(prob.of.presence = mean(presence)) %>% 
  left_join(all.sims.for.projection %>%  
              rownames_to_column("sim.row")) 
  #filter (Year %in% c(2015, 2095))
  )) -> posterior.probabilities.by.taxa
```
Now we have a nested dataframe per each phylum. Not that we need it. But the nested part is a dataframe with the mean result of the 100 draws for each environmental point.

```{r subset of taxa for manuscript}
## Now create a set of phyla and taxa to show on figure 3


posterior.probabilities.by.taxa %>%
  mutate(suma = map (data,~.x %>% group_by(taxa, Year) %>%
                       summarise(tot = sum(prob.of.presence)) %>%
                       ungroup() %>% 
                       pivot_wider(names_from = Year, values_from = tot) %>% 
                       group_by(taxa) %>% mutate(diff = `2017` - `2095`))) %>% 
  select(phylum, suma) %>% 
  unnest(suma) %>%
  arrange(desc(abs(diff))) %>% 
  filter (phylum %in% c("Bacillariophyta", "Dinophyceae", "Haptophyceae", "Arthropoda")) %>% 
  group_by(phylum) %>% 
  slice(1:5) %>% 
  pull(taxa)-> taxa.for.Fig3

posterior.probabilities.by.taxa %>%
  mutate(suma = map (data,~.x %>% group_by(taxa,Area, Year) %>%
                       summarise(tot = sum(prob.of.presence)) %>%
                       ungroup() %>% 
                       pivot_wider(names_from = Year, values_from = tot) %>% 
                        group_by(taxa) %>% mutate(diff = `2017` - `2095`)
                     )) %>% 
  select(phylum, suma) %>% 
  unnest(suma) %>%
 # arrange(desc(abs(diff))) %>% 
  group_by(phylum) %>% 
  arrange(desc(abs(diff))) %>%
  slice(1:5) %>% 
  ggplot(aes(x = fct_reorder(phylum,abs(diff)), y = abs(diff))) +
  geom_boxplot()+
  geom_point(aes(color = diff>0)) +
  coord_flip()

posterior.probabilities.by.taxa %>%
  mutate(suma = map (data,~.x %>% group_by(taxa,Area, Year) %>%
                       summarise(tot = sum(prob.of.presence)) %>%
                       ungroup() %>% 
                       pivot_wider(names_from = Year, values_from = tot) %>% 
                        group_by(taxa) %>% mutate(diff = `2017` - `2095`)
                     )) %>% 
  select(phylum, suma) %>% 
  unnest(suma) %>%
 # arrange(desc(abs(diff))) %>% 
  group_by(phylum) %>% 
  arrange(desc(abs(diff))) %>%
  slice(1:5) %>% 
  ungroup() %>% 
  filter(phylum %in% c("Bacillariophyta", "Dinophyceae", "Haptophyceae", "Chlorophyta")) %>% 
  distinct(taxa) %>% 
  pull() -> taxa.for.Fig3.2
```


```{r plotting them}
### some for fig3 ### 
posterior.probabilities.by.taxa %>% 
  filter (phylum %in% c("Bacillariophyta", "Dinophyceae", "Haptophyceae", "Arthropoda")) %>% 
  mutate( plot.by.taxa = map2 (data, phylum, ~ .x %>% 
                                 filter(taxa %in% taxa.for.Fig3) %>% 
      separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species))    %>% 
    mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>% 
    mutate(Year = fct_rev(as.factor(Year) )) %>% 
                        
  ggplot(aes(x= prob.of.presence,
             y = label)) +
  #geom_density_ridges(fill = as.factor(Year))
  # stat_density_ridges(aes(fill = as.factor(Year)),
  #    geom = "density_ridges_gradient", calc_ecdf = TRUE,
  #   quantiles =2, quantile_lines = TRUE, alpha = 0.5
  # ) +
    geom_violin(aes(fill= (Year)), weight = 2, adjust = .5, draw_quantiles =  0.5)+
# stat_summary(fun.y=mean, geom="line", aes(group=Year)) +
  scale_fill_brewer(name = "Year",  type = "qual", palette = 4, direction = 1, breaks=c("2017","2095")) + 
  labs (x = "Probability of presence",
        y = "") +
    facet_wrap(~Area) +
  
  
 # facet_grid(phylum ~ Area) + coord_flip(xlim = c(0,1)) +
 theme(strip.text.y = element_text(angle = 0),
       axis.text.y = element_text(face = "italic")) +
   ggtitle(.y) +
  theme(legend.direction = "horizontal",
        legend.position  = "bottom") ))   -> list.of.plots.for.fig3

#A new subset to high;ight change

posterior.probabilities.by.taxa %>% 
  filter (phylum %in% c("Bacillariophyta", "Dinophyceae", "Haptophyceae", "Chlorophyta")) %>% 
  mutate( plot.by.taxa = map2 (data, phylum, ~ .x %>% 
                                 filter(taxa %in% taxa.for.Fig3.2) %>% 
      separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species))    %>% 
    mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>% 
    mutate(Year = fct_rev(as.factor(Year) )) %>% 
                        
  ggplot(aes(x= prob.of.presence,
             y = label)) +
  #geom_density_ridges(fill = as.factor(Year))
  # stat_density_ridges(aes(fill = as.factor(Year)),
  #    geom = "density_ridges_gradient", calc_ecdf = TRUE,
  #   quantiles =2, quantile_lines = TRUE, alpha = 0.5
  # ) +
    geom_violin(aes(fill= (Year)), weight = 2, adjust = 1, draw_quantiles =  0.5, scale = "count")+
# stat_summary(fun.y=mean, geom="line", aes(group=Year)) +
  scale_fill_brewer(name = "Year",  type = "qual", palette = 4, direction = 1, breaks=c("2017","2095")) + 
  labs (x = "Probability of presence",
        y = "") +
    facet_wrap(~Area) +
  
  theme_minimal() +
  
 theme(strip.text.y = element_text(angle = 0),
       axis.text.y = element_text(face = "italic"),
       legend.direction = "horizontal",
       legend.position  = "bottom",
       plot.title.position = "plot",
       plot.title = element_text(face = "bold",vjust =  -5 ),
       axis.title.x.top  = element_text(face = "bold",vjust = 3) ) +
   ggtitle(.y)  + 
  scale_x_continuous(limits = c(0,1),position = "top")))  -> list.of.plots.for.fig3.2

list.of.plots.for.fig3.2$plot.by.taxa[[1]]
```


```{r plots for supp}
## some for suppmat
posterior.probabilities.by.taxa %>% 
  mutate( plot.by.taxa = map2 (data, phylum, ~ .x %>% 
                      separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species))    %>% 
    mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>% 
                        
  ggplot(aes(x= prob.of.presence,
             y = label)) +
  #geom_density_ridges(fill = as.factor(Year))
 #stat_density_ridges(aes(fill = as.factor(Year)),
    # geom = "density_ridges_gradient", calc_ecdf = TRUE,
  #  quantiles =2, quantile_lines = TRUE, alpha = 0.5
  #) +
   geom_violin(aes(group = ))
  scale_fill_brewer(name = "Year",  type = "qual", palette = 2) + 
  labs (x = "Probability of presence",
        y = "") +
    facet_wrap(~Area) +
  
  
 # facet_grid(phylum ~ Area) + coord_flip(xlim = c(0,1)) +
 theme(strip.text.y = element_text(angle = 0),
       axis.text.y = element_text(face = "italic")) +
   ggtitle(.y) +
  theme(legend.direction = "horizontal",
        legend.position  = "bottom") ))   -> list.of.plots

png(file = here("Figures","taxadensityplots.by.phylum","all.by.area.png"), width = 14, units = "in", res = 300)
list.of.plots %>% pull(plot.by.taxa)
dev.off()
#
# list.of.plots %>% slice(1) %>% pull(plot.by.taxa)-> one.plot
# legend.left <- get_legend(one.plot[[1]] )
# 
# list.of.plots %>% mutate(plot.by.taxa= map(plot.by.taxa, ~.x + theme(legend.position = "none") )) -> list.of.plots

```

#### Now do change in suitability by taxa by time - for the supp

```{r}
selected.taxa <- models %>% select(taxa) %>% filter (str_detect(taxa, "Chaetoceros|huxleyi|Alexandrium|Nitzschia|Karlodinium")) %>% pull(taxa)
```

Here I will unnest the whole thing - maybe better to always keep it unnested

```{r}
posterior.probabilities.by.taxa %>% 
  unnest(data) ->  posterior.probabilities.by.taxa
```


Now something for the supporting information

```{r}
posterior.probabilities.by.taxa %>% 
  filter (taxa %in% selected.taxa) %>% 
  separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species)) %>% 
  group_by(phylum) %>% 
   ggplot(aes(x= prob.of.presence,
             y = label)) +
  #geom_density_ridges(fill = as.factor(Year))
  stat_density_ridges(aes(fill = as.factor(Year)),
    # geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles =2, quantile_lines = TRUE, alpha = 0.5
  ) + 
  scale_fill_brewer(name = "Year",  type = "qual", palette = 2) + 
  labs (x = "Probability of presence",
        y = "") +
  facet_grid(phylum ~ Area, scales = "free_y") +
   # facet_wrap(~Area) +
  
  
 # facet_grid(phylum ~ Area) + coord_flip(xlim = c(0,1)) +
 theme(strip.text.y = element_text(angle = 0),
       axis.text.y = element_text(face = "italic")) +
  # ggtitle(.y) +
  theme(legend.direction = "horizontal",
        legend.position  = "bottom") +
  ggsave(here("Figures","Most.varied.taxa.png"), width = 14, dpi = "retina")
```



```{r change over time only for supp}
posterior.probabilities.by.taxa %>% 
  group_by(taxa, Area) %>% 
  filter (Year == 2017) %>% 
  summarise(median2017 = median (prob.of.presence)) %>% 
  right_join(posterior.probabilities.by.taxa %>% 
               filter (taxa %in% selected.taxa)) %>% 
  mutate(Corrected.presence = prob.of.presence - median2017) -> almost.there 
  
almost.there %>% 
  group_by(taxa, Area, Year, phylum) %>% 
  summarise_at ("Corrected.presence", .funs = list (median = median, sd = sd)) %>% 
  filter (Year == 2095) %>% 
  ggplot(aes (x = median)) +
  geom_histogram() # establish a cutoff of +- 0.2

almost.there %>% 
  group_by(taxa, Area, Year, phylum) %>% 
  summarise_at ("Corrected.presence", .funs = list (mean = median, sd = sd)) %>% 
 filter (Year == 2095, abs(mean) > 0.10 ) %>%  ungroup %>% select(taxa, Area) -> subset.for.the.plot
  

almost.there %>% 
  group_by(taxa, Area, Year, phylum) %>% 
  summarise_at ("Corrected.presence", .funs = list (mean = median, sd = sd)) %>% 
  right_join(subset.for.the.plot) %>% 
  separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species)) %>% 
  ungroup() %>% 
  mutate(Area = case_when(Area == "SJI"    ~ "San Juan Island",
                          TRUE             ~ Area)) %>% 
  
ggplot(aes(x = Year,
             y = mean))+
  geom_pointrange(aes (color = phylum,
                       ymin = mean - sd,
                       ymax = mean + sd))+
  geom_line(aes(group = taxa)) +
  geom_label_repel(data = . %>% filter (Year == 2095), aes(label = label,
                                                     fill = phylum))+
  facet_wrap(~Area) +
  theme(legend.position ="bottom") +
  ggsave(here("Figures","Suitability change.png"), width = 14) -> bottom.plot.figure3

```


### Richness by phyla with time
 First create the square matrix of points
```{r create full grid}
 
all.sims.for.projection  %>% 
  group_by(  Area) %>% 
  # filter (keep == "keep") %>%   
  summarise_at(c("TemperatureCelsius", "pH_units"), list(max = max, min = min)) %>% 

  group_by ( Area) %>% 
  nest() %>% 
  mutate(data = map (data, ~ expand_grid(TemperatureCelsius = seq(round(.x$TemperatureCelsius_min,1), round(.x$TemperatureCelsius_max, 1),by = 0.1),
                                         pH_units = seq(round(.x$pH_units_min,1), round(.x$pH_units_max,1), by = 0.1)))) %>% 
  unnest(data) -> full.grid
```


```{r add real temperatures to the grid}

full.grid %>% 
  ungroup() %>% 
  rownames_to_column("Case") %>% 
  rename(Temperature = TemperatureCelsius,
         pH = pH_units) %>% 
  
  pivot_longer(cols = c(Temperature, pH),
               names_to  = "Predictor",
               values_to = "value") %>% 
  group_by(Area, Predictor) %>% 
  nest() %>% 
  left_join(transforming.df) %>% 
  mutate(data = map2(data, to.std, ~.x %>% 
                       mutate(std = .y[1]+.y[2]*value ))) %>% 
  select(Area, Predictor, data) %>% 
  unnest(data) %>% 
  pivot_wider(names_from = Predictor,
              values_from = c(std,value)) %>% 
  rename(Temperature = std_Temperature,
         pH = std_pH,
         TemperatureCelsius = value_Temperature,
         pH_units           = value_pH) -> full.grid
```

`full.grid` has the temperature and pH values we want to project our models to - so now we use it with the `models` output. 

```{r calculate the 100 draws from the posterior}
models %>% 
  ungroup() %>%  #rpk added
  transmute(taxa, 
            post.draws = map2 (model, taxa, ~ posterior_predict(object = .x,
                                                                newdata = full.grid,
                                                                draws = 100) %>% 
                                 as_tibble() %>% 
                                 t(.) %>% 
                                 as_tibble() %>% 
                                 rownames_to_column("sim.row") )) -> posterior.draws.raster
```


```{r calculate richness}
posterior.draws.raster %>% 
 left_join(phylum.info %>% dplyr::select(phylum, taxa)) %>% 
  group_by(phylum) %>% 
  nest() %>% 
  mutate(data = map (data, ~ .x %>% unnest(cols= post.draws) %>% 
                       pivot_longer(cols = c(-taxa, -sim.row),
                                    names_to = "draw.row", values_to = "presence") %>% 
                       group_by(draw.row, sim.row) %>% 
                       summarise(tot = sum(presence)) %>% 
                       group_by(sim.row) %>% 
                       summarise_at(.vars = "tot", .funs = list(Richness = mean,sd = sd)))) %>% 
  unnest(data) -> ready_plot

ready_plot %>% 
  left_join(full.grid %>%  
              rownames_to_column("sim.row")) -> ready_plot

# Normailzed the data for each phyla

ready_plot %>% 
  group_by(phylum) %>% 
  mutate(st.richness = Richness / max(Richness)) -> ready_plot

```
 
 
```{r plot3 function}
plot3 <- function(tibble,string , response) {
  
  response = enquo(response)
  
  
  tibble %>% 
    ungroup() %>% 
    mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>% 
    group_by(TemperatureCelsius, pH_units, Area) %>% 
   
    summarise (!!response := mean (!!response))  %>% 
  
    ggplot(aes(x = round(TemperatureCelsius,10),
             y = round(pH_units, 10))) +
  
  geom_raster( interpolate = T,aes( fill = !!response)) +
  
  scale_fill_distiller(name = "Standarized Richness", type = "seq", palette = "Spectral",limits=c(0,1) ) +
  
  # geom_density2d(data = simData %>%
  #                   filter (Year %in% c(2015, 2095)),
  #                 aes(x= TemperatureCelsius, y = pH_units, group= Year, color = as.factor(Year)), bins = 5, alpha = 0.5) +
 
  scale_color_brewer(name = "Year",  type = "qual", palette = 4, direction = -1, breaks=c("2017","2095")) +
  # ggforce::geom_mark_hull(data = all.sims.for.projection %>%
  #                           ungroup() %>% 
  #                           mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
  #                           TRUE          ~ Area)) %>%
  #                           filter (Year %in% c(2017, 2095), keep == "keep") ,
  #                         aes(x= TemperatureCelsius, y = pH_units, group= Year, color = as.factor(Year),label = as.factor(Year)),
  #                         expand = unit(0.5, "mm"),
  #                label.margin = margin(1, 1, 1, 1, "mm"),
  #                label.buffer = unit(0, "mm"),
  #                con.cap = 0 ,
  #                alpha = 0.5) +
     facet_grid(.~Area) +
  guides(color = "none") +
    labs (x = "Temperature",
          y= "pH") +
    theme_minimal()+
    theme(legend.position = "bottom",
          legend.key.width  = unit(2 ,"cm"),
          axis.title.x = element_text(face = "bold"),
          legend.direction = "horizontal") +
    scale_x_continuous(position = "top")
  
  
}
```
 
```{r}
ready_plot %>% 
  nest(-phylum) %>% 
  mutate(plot = map2(data, phylum, ~ plot3(.x, .y, response = st.richness)))  -> list.of.richness.plots

# # Get the other legend
# list.of.richness.plots %>% slice(1) %>% pull(plot) -> one.plot
# legend.right <- get_legend(one.plot[[1]]  )
# list.of.richness.plots %>% 
#   mutate(plot = map (plot, ~.x + theme(legend.position = "none"))) -> list.of.richness.plots
# legend.left

```

```{r}
posterior.probabilities.by.taxa %>% 
  group_by(phylum) %>% 
  summarise(n_distinct(taxa)) %>% 
  pull -> list.of.number.of.taxa


list.of.plots %>%  pull(phylum) -> list.of.phyla

list.of.plots %>% pull(plot.by.taxa) -> list.of.ridge.plots

list.of.ridge.plots <- set_names(list.of.ridge.plots, nm = list.of.phyla)

list.of.richness.plots %>% pull(plot) -> list.of.raster.plots

list.of.raster.plots <- set_names(list.of.raster.plots, nm = list.of.phyla)

# # Use the fig3 ridges
# list.of.plots.for.fig3 %>% pull(plot.by.taxa) %>% 
#   map(function(.x) .x + theme(legend.position = "none")) %>% 
#   set_names(nm = list.of.plots.for.fig3$phylum) -> list.of.ridge.plots.fig3
# 
# 
# map2(list.of.ridge.plots.fig3, list.of.raster.plots[list.of.plots.for.fig3$phylum],
#      function(.x, .y) plot_grid (.x, .y, nrow = 1, align = "hv", axis = "right")) %>% 
#   set_names(list.of.plots.for.fig3$phylum)-> combined.plots
# 
# 
# 
# map2(list.of.ridge.plots,list.of.phyla, 
#      ~ ggsave(.x, filename = here("Figures",paste0(.y, "ridges.png")), width = 14, 
#                                   #height = c*20,
#                                   dpi = "retina"))
# ggsave(list.of.ridge.plots[["Bacillariophyta"]], filename = here("Figures","Bacillariophytaridges.png"), width = 14, height = 14,                                  dpi = "retina")
# 
# map2(list.of.raster.plots,list.of.phyla, 
#      ~ ggsave(.x, filename = here("Figures",paste0(.y, "raster.png")), width = 7, 
#                                   #height = c*20,
#                                   dpi = "retina"))
# map2(list.of.raster.plots,list.of.phyla, 
#      ~ .x + 
#        ggtitle(.y) + ggsave(filename = here("Figures",paste0(.y, "rastertitle.png")), width = 7, 
#                                   #height = c*20,
#                                   dpi = "retina"))
```

```{r}


# plot_grid(plotlist = combined.plots,
#           nrow = 1,axis = "l",
#           align = "hv",
#             ) -> top.all
# 
# plot_grid(legend.left, legend.right, 
#           nrow = 2, align = "hv" ) -> midlayer
# 
# 
# plot_grid(bottom.plot.figure3, midlayer,
#           nrow = 1,
#           rel_widths = c(1,0.2),
#           align = "hv") -> bottom.plots
# 
# 
# top.all + ggsave(here("Figures","Top_fig3.png"), dpi = "retina", width = 28, height = 10)
# 
# bottom.plot.figure3 + ggsave(here("Figures","bottom.fig.3.png"), dpi ="retina", width = 14)
# 
# midlayer + ggsave(here("Figures","legends.fig3.png"), dpi = "retina", height = 2)

```

# Redesign

```{r}
list.of.ridge.plots.fig3 %>% map(get_title) -> list.of.titles
list.of.ridge.plots.fig3 %>% map(function(x) x + theme(plot.title = element_blank())) -> list.of.ridge.plots.fig3

plot_grid(list.of.titles[[1]],list.of.titles[[2]], 
          list.of.titles[[3]],list.of.titles[[4]],  nrow = 4,
          align = "hv") -> titles
plot_grid(plotlist = list.of.ridge.plots.fig3, axis = "r",
          nrow = 4,
          align = "hv" ) -> topleft

plot_grid(plotlist = list.of.raster.plots[list.of.plots.for.fig3$phylum], axis = "l",
          nrow = 4,
          align = "hv" ) -> topright

plot_grid(titles, topleft, topright,rel_widths = c(1,5,5),
          ncol = 3,align = "v",axis = "tblr", labels = c("A",NA,"B") ) -> top.together


plot_grid(legend.left, legend.right, get_legend(bottom.plot.figure3),
          nrow = 3, align = "hv" ) -> midlayer
bottom.plot.figure3 + theme(legend.position = "none") -> goodnow
plot_grid(goodnow, midlayer,
          rel_widths = c(2,1),
          labels = c("C",NA),
          ncol = 2,align = "v", axis = "t") -> bottom.together
          

plot_grid(top.together, bottom.together,
          nrow = 2, rel_heights = c(4,1),
          align = "h", axis = "rl") + 
  ggsave(here("Figures","Top_fig3.png"), dpi = "retina", width = 24, height = 32)
ggsave(here("Figures","Top_fig3.18.png"), dpi = "retina", width = 18, height = 24)
```


# Patchwork

```{r}
library(patchwork)

# Ridge plots
list.of.plots.for.fig3 %>%
  pull(plot.by.taxa) %>% set_names(list.of.plots.for.fig3$phylum) %>%
  map(function(x) x +  theme_minimal()+ theme(plot.title.position = "plot",
                                              plot.title = element_text(face = "bold",vjust =  -5 ),
                                              axis.title.x.top  = element_text(face = "bold",vjust = 3),
                                              legend.direction = "horizontal",
                                              axis.text.y = element_text(face = "italic"))
       + scale_x_continuous(limits = c(0,1),position = "top")
      ) -> lefts
lefts[[1]]
# remove redundant axis and facet labels

lefts[2:4] <- map(lefts[2:4], function(x) x + labs(x= "") + theme( strip.text.x = element_blank())  + scale_x_continuous(position = "top"))

# Raster plots
list.of.richness.plots %>%
  pull(plot) %>%
  set_names(list.of.richness.plots$phylum) %>%
  .[list.of.plots.for.fig3$phylum] %>%
  map(function(x) x + theme_minimal()+ theme(axis.title.x = element_text(face = "bold"),
                                                                                                                                                                       legend.direction = "horizontal") + scale_x_continuous(position = "top")) -> rights

# remove redundant axis and facet labels

rights[2:4] <- map(rights[2:4], function(x) x +
                     labs(x= "") +
                     ggforce::geom_mark_hull(data = all.sims.for.projection %>%
                            ungroup() %>% 
                            mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                             TRUE          ~ Area)) %>%
                            filter (Year %in% c(2017, 2095), keep == "keep") ,
                          aes(x= TemperatureCelsius, y = pH_units, group= Year, color = as.factor(Year)),
                          expand = unit(0.5, "mm"),
                 con.cap = 0 ,
                 alpha = 0.5) +
    theme( strip.text.x = element_blank()))

# Variation plot
bottom.plot.figure3 + theme_minimal() -> bottom.plot.figure3



lefts[["Arthropoda"]] +  rights[["Arthropoda"]] +
   lefts[["Bacillariophyta"]] +   rights[["Bacillariophyta"]] +
   lefts[["Haptophyceae"]]  + rights[["Haptophyceae"]] +
   lefts[["Dinophyceae"]]  + rights[["Dinophyceae"]] +
   #bottom.plot.figure3 + guide_area() +

  plot_layout(ncol = 2, widths = c(3,2),
  guides = "collect",) -> test


## Guides differently

((guide_area()/
  lefts[["Arthropoda"]]/
  lefts[["Bacillariophyta"]] /
   lefts[["Haptophyceae"]] /
    lefts[["Dinophyceae"]] + 
    plot_layout(heights = c(0.5,3,3,3,3), guides = "collect")) |
    plot_spacer() |
    (guide_area() /
                                          rights[["Arthropoda"]]/
                                          rights[["Bacillariophyta"]]/
                                          rights[["Haptophyceae"]]/
                                          rights[["Dinophyceae"]] + 
                                          plot_layout(heights = c(0.5,3,3,3,3), guides = "collect"))) +
  plot_layout(widths = c(3,0.25,2))-> test
ggsave( filename = here("Figures","Top_fig3_20200615.18.png"),plot = test, units = "in", dpi = "retina", width = 12, height = 18)

##
list.of.plots.for.fig3.2 %>%
  pull(plot.by.taxa) %>% set_names(list.of.plots.for.fig3.2$phylum) -> lefts
  
lefts[[1]]
# remove redundant axis and facet labels

lefts[2:4] <- map(lefts[2:4], function(x) x + labs(x= "") + theme( strip.text.x = element_blank())  + scale_x_continuous(position = "top"))

list.of.richness.plots %>%
  pull(plot) %>%
  set_names(list.of.richness.plots$phylum) %>%
  .[list.of.plots.for.fig3.2$phylum] -> rights
  
rights[[1]]<- rights[[1]]+ ggforce::geom_mark_hull(data = all.sims.for.projection %>%
                            ungroup() %>%
                            mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>%
                            filter (Year %in% c(2017, 2095), keep == "keep") ,
                          aes(x= TemperatureCelsius, y = pH_units, group= Year, color = as.factor(Year),label = as.factor(Year)),
                          expand = unit(0.5, "mm"),
                 label.margin = margin(1, 1, 1, 1, "mm"),
                 label.buffer = unit(0, "mm"),
                 con.cap = 0 ,
                 alpha = 0.5) 

# remove redundant axis and facet labels

rights[2:4] <- map(rights[2:4], function(x) x +
                     labs(x= "") +
                     ggforce::geom_mark_hull(data = all.sims.for.projection %>%
                            ungroup() %>% 
                            mutate(Area = case_when(Area == "SJI" ~ "San Juan Island",
                            TRUE          ~ Area)) %>%
                            filter (Year %in% c(2017, 2095), keep == "keep") ,
                          aes(x= TemperatureCelsius, y = pH_units, group= Year, color = as.factor(Year)),
                          expand = unit(0.5, "mm"),
                 con.cap = 0 ,
                 alpha = 0.5) +
    theme( strip.text.x = element_blank()))

((guide_area()/
  lefts[["Bacillariophyta"]]/
  lefts[["Chlorophyta"]] /
   lefts[["Haptophyceae"]] /
    lefts[["Dinophyceae"]] + 
    plot_layout(heights = c(0.5,3,3,3,3), guides = "collect")) |
    plot_spacer() |
    (guide_area() /
                                          rights[["Bacillariophyta"]]/
                                          rights[["Chlorophyta"]]/
                                          rights[["Haptophyceae"]]/
                                          rights[["Dinophyceae"]] + 
                                          plot_layout(heights = c(0.5,3,3,3,3), guides = "collect"))) +
  plot_layout(widths = c(2,0.25,3))-> test

 
ggsave( filename = here("Figures","Top_fig3_20200615.18.Other.sel.png"),plot = test, units = "in", dpi = "retina", width = 12, height = 18)
```

? Emiliainia huxleyi
```{r}
posterior.probabilities.by.taxa %>% 
  filter(phylum == "Haptophyceae") %>% 
  unnest() %>% 
  filter(str_detect(taxa, "huxleyi")) %>% 
  ggplot(aes(x = prob.of.presence))+
 # geom_violin(scale="area") +
 # geom_density_ridges() +
  facet_wrap(~Area) +
  theme(legend.position = "none") -> p


p +geom_violin(aes( y= as.factor(Year), fill = as.factor(Year)), scale="area")+ ggtitle("scale = 'area' ") -> left.1

p +geom_violin(aes( y= as.factor(Year)),scale="count")+ ggtitle("scale = 'count' ") -> cent.1  

p +geom_violin(aes( y= as.factor(Year)),scale="width")+ ggtitle("scale = 'width' ") -> right.1



left.1 + geom_boxplot(aes( y= as.factor(Year), fill = as.factor(Year)))
cent.1 + facet_grid(Year~Area)
right.1 + facet_grid(Year~Area)

p + geom_violin(scale="area", )
  cent.1 + right.1
```

# Less is more

What if we reduce the figure 3 to a dinoflagellate vs diatoms and 

```{r which to choose}
posterior.probabilities.by.taxa %>% 
  ungroup() %>% 
  filter (phylum %in%c("Dinophyceae", "Bacillariophyta")) %>% 
  mutate(suma = map (data,~.x %>% group_by(taxa,Area, Year) %>%
                       summarise(tot = sum(prob.of.presence)) %>%
                       ungroup() %>% 
                       pivot_wider(names_from = Year, values_from = tot) %>% 
                        group_by(taxa) %>% mutate(diff = `2017` - `2095`)
                     )) %>% 
  select(phylum, suma) %>% 
  unnest(suma) %>%
  separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species))  %>%  
  ggplot(aes(x = fct_reorder(phylum,abs(diff)), y = diff)) +
  geom_boxplot()+
  geom_point(aes(color = diff>0)) +
  geom_label_repel(data = . %>% group_by(phylum) %>% arrange(desc(abs(diff))) %>% slice(1:5) , aes(label = label))+
  coord_flip() +
  facet_wrap(~Area)
```

```{r select some }
posterior.probabilities.by.taxa %>% 
  ungroup() %>% 
  filter (phylum %in%c("Dinophyceae", "Bacillariophyta")) %>% 
  mutate(suma = map (data,~.x %>% group_by(taxa,Area, Year) %>%
                       summarise(tot = sum(prob.of.presence)) %>%
                       ungroup() %>% 
                       pivot_wider(names_from = Year, values_from = tot) %>% 
                        group_by(taxa) %>% mutate(diff = `2017` - `2095`)
                     )) %>% 
  select(phylum, suma) %>% 
  unnest(suma) %>%
  group_by(phylum) %>% arrange(desc(abs(diff))) %>% 
  separate(taxa, into = c("family","genus", "species"), sep = "\\|", remove = F) %>%
  mutate(label = case_when((species == "NA" & genus == "NA") ~ paste0(family, " sp."),
                           species == "NA" ~  paste0(genus, " sp."),
                           TRUE            ~ species)) -> taxa.and.diff

taxa.and.diff %>%
  slice(1:5) %>%
  arrange(diff) %>% pull(taxa) -> ahorasi

taxa.and.diff %>% 
  slice(1:5) %>%
  arrange(diff) %>% pull(label) -> reorder.labels

 
```

# Besides Figures: other stats reported in the MS
```{r}
ASV.table  <- read_csv(here("Output","ASV_table_all_together.csv"))

Annotation <- read_csv(here("Input","Annotated.hashes.csv"))

## Remove HUmans and chickenfilter(!str_detect(taxa, "Phasianidae"))

ASV.table %>% 
  filter(!Hash %in%  (Annotation %>% 
           filter (str_detect(species, "Homo")) %>% 
           pull(Hash))) -> ASV.table


ASV.table %>% 
  summarise(runs = n_distinct(Miseq_run),
            reads = sum(nReads),
            asvs = n_distinct(Hash)) -> totalreads

## collapse the dataset by taxonomy

left_join(ASV.table, Annotation) %>% 
  unite(family, genus, species, col = "taxa", sep = "|") %>% 
  filter(taxa != "NA|NA|NA") %>% 
  select(taxa, sample, nReads, benthos) %>% 
  group_by(taxa, benthos, sample) %>% 
  summarise(nReads = sum(nReads)) -> ASV.by.taxa



ASV.by.taxa %>% 
  group_by(benthos) %>% 
  summarise(reads = sum(nReads),
            taxa = n_distinct(taxa)) -> benthostaxareads

ASV.by.taxa %>% 
  ungroup() %>% 
  summarise(reads = sum(nReads),
            taxa = n_distinct(taxa)) -> taxareads

ASV.by.taxa %>% 
  separate(sample, into = c("Site", "biol"), sep = "_", remove = F) %>% 
  separate(biol, into = c("biol", "tech.rep"), sep = "\\.") %>% 
  separate(biol, into = c("date", "biol.rep"), sep = -1) %>% 
  unite (Site, date, col = "event") -> ASV.by.taxa


ASV.by.taxa %>% 
  filter (benthos != "BEN") %>% 
      mutate(
        Season = case_when(
          str_detect(sample, "1703|1710|1711|1801|1803") ~ "Winter",
          TRUE ~ "Summer"
        ),
        Area = case_when(
          str_detect(sample, "CP|LK|FH") ~ "SJI",
          TRUE ~ "Hood Canal"
        )
      ) %>% 
 group_by(Area) %>%
  nest() %>% 
  mutate(data = map (data, ~.x %>% group_by(taxa) %>% summarise (tot = sum(nReads)))) %>% unnest() %>% 
  pivot_wider(names_from = Area, values_from = tot, values_fill = list(tot = 0)) %>% 
  mutate(shared = case_when(SJI > 0 & `Hood Canal` > 0 ~ "Shared",
                            SJI != 0 & `Hood Canal` == 0 ~ "Only SJI",
                            SJI == 0 & `Hood Canal` != 0 ~ "Only HC")) %>% 
  group_by(shared) %>% #tally
summarise (tot = sum(SJI + `Hood Canal`),
                                 ncases = n())
```
#### Does richness change within phylum between Years

```{r}
  posterior.draws.all %>% 
    left_join(phylum.info %>% select(phylum, taxa)) %>% 
    group_by(phylum) %>% 
    nest() %>% 
  #  slice(1) %>%
    mutate(data = map (data, ~ .x %>%
                         unnest() %>% 
                         pivot_longer(cols = c(-taxa, -sim.row),
                                      names_to = "draw.row",
                                      values_to = "presence")  %>% 
                         group_by(draw.row, sim.row) %>% 
                         summarise(tot = sum(presence)) %>% 
                         group_by(sim.row) %>% 
                         summarise_at(.vars = "tot", .funs = list(Richness = mean,sd = sd)) %>% 
  left_join(all.sims.for.projection %>%  
              rownames_to_column("sim.row")) ))%>%
    
   mutate(lm = map(data, ~ lm(Richness ~ Year, data = .x)),
         lm.results = map (lm, broom::tidy))  -> results.lm
   
### Using a wilcox test to see if there is a difference between Years

results.lm %>% 
  mutate(wilcoxon = map (data, ~ wilcox.test(Richness ~ Year, data = .x) ),
         tidy.w   = map (wilcoxon, broom::tidy)) -> results.lm

results.lm %>% select(phylum, wilcoxon) %>% filter (phylum == "Bacillariophyta") %>% pull(wilcoxon) 
```

